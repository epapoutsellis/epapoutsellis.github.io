<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CIL on the Cloud | Evangelos  Papoutsellis</title>
    <meta name="author" content="Evangelos  Papoutsellis">
    <meta name="description" content="Tomography reconstruction on the Cloud">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    
    <!-- Sidebar Table of Contents -->
    <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet">
        

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8F%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="epapoutsellis/blog/2023/cil-colab/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Evangelos </span>Papoutsellis</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">home</a>
              </li>
              <!-- Comment blog section -->
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/news/">news</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/software/">software</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        
        <div class="row">
          <!-- sidebar, which will move to the top on a small screen -->
          <div class="col-sm-3">
            <nav id="toc-sidebar" class="sticky-top"></nav>
          </div>
          <!-- main content area -->
          <div class="col-sm-9">
            <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">CIL on the Cloud</h1>
    <p class="post-meta">June 6, 2023</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>
        ·  
        <a href="/blog/category/cil">
          <i class="fas fa-tag fa-sm"></i> CIL</a>  
          

    </p>
  </header>

  <article class="post-content">
    
    <div id="markdown-content">
      <p>In this blog, we will demonstrate how to use the Core Imaging Library (CIL), an open source software for imaging inverse problems, on cloud platforms like Binder and Google Colab. These platforms offer cloud-based environments with pre-installed packages and resources, making them highly suitable for teaching and training purposes. In addition, if you do not have a GPU or you are a macOS user without GPU or without the right GPU these cloud platforms serve as an excellent alternative. Or maybe you lost connection to your Windows/Linux remote machines and you really want to reconstruct a tomographic dataset.</p>

<h2 id="outline">Outline</h2>
<ul>
  <li><a href="#section1">What is CIL?</a></li>
  <li>
<a href="#section2">Cloud platforms: Google Colab and Binder</a>
    <ul>
      <li><a href="#subsection21">Binder or Colab</a></li>
    </ul>
  </li>
  <li>
<a href="#section3">Install CIL on Colab</a>
    <ul>
      <li><a href="#subsection31">Check Python version</a></li>
      <li><a href="#subsection32">Install TIGRE</a></li>
      <li><a href="#subsection33">Install CondaColab</a></li>
      <li><a href="#subsection34">Install Conda</a></li>
      <li><a href="#subsection35">Install CIL</a></li>
    </ul>
  </li>
  <li>
<a href="#section4">Tomography reconstruction using CIL</a>
    <ul>
      <li><a href="#subsection41">Import CIL</a></li>
      <li><a href="#subsection42">Import Tomography backends</a></li>
      <li><a href="#subsection43">Load and examine real 3D dataset</a></li>
      <li><a href="#subsection44">Preprocess Acquisition Data</a></li>
      <li><a href="#subsection45">Run analytic reconstruction: FBP using Astra and Tigre</a></li>
      <li><a href="#subsection46">Run Model-Based iterative reconstruction: Total variation reconstruction</a></li>
      <li><a href="#subsection47">Discussion</a></li>
    </ul>
  </li>
  <li><a href="#section5">CIL Demos on Colab</a></li>
</ul>

<h2 id="what-is-cil--">What is CIL?  <a class="anchor" id="section1"></a>
</h2>

<p>The Core Imaging Library or CIL is an open-source Python framework for solving inverse problems in imaging with particular emphasis on tomographic imaging and reconstruction. It is supported by the <a href="https://ccpi.ac.uk/" rel="external nofollow noopener" target="_blank">Collaborative Computational Project in Tomographic Imaging (CCPi)</a>, a UK academic network, which unites expertise in the field of Computed Tomography (CT). Its aim is to provide the community with software to increase the quality and level of information that can be extracted by CT, with an emphasis in software sustainability, maintainability and distribution.</p>

<p>To learn more about CIL, please check the links below.</p>

<ul>
  <li>
<strong>Github Repositories</strong>
    <ul>
      <li><a href="https://github.com/TomographicImaging/CIL" rel="external nofollow noopener" target="_blank">CIL</a></li>
      <li><a href="https://github.com/TomographicImaging/CIL-Demos" rel="external nofollow noopener" target="_blank">CIL-Demos</a></li>
    </ul>
  </li>
  <li>
<strong>Software Papers</strong>
    <ul>
      <li>
<a href="https://royalsocietypublishing.org/doi/abs/10.1098/rsta.2020.0192" rel="external nofollow noopener" target="_blank">Core Imaging Library–Part I: a versatile Python framework for tomographic imaging</a>. <a href="https://github.com/TomographicImaging/Paper-2021-RSTA-CIL-Part-I" rel="external nofollow noopener" target="_blank">Code</a>
</li>
      <li>
<a href="https://royalsocietypublishing.org/doi/abs/10.1098/rsta.2020.0193" rel="external nofollow noopener" target="_blank">Core Imaging Library–Part II: Multichannel reconstruction for dynamic and spectral tomography</a>. <a href="https://github.com/TomographicImaging/Paper-2021-RSTA-CIL-Part-II" rel="external nofollow noopener" target="_blank">Code</a>
</li>
    </ul>
  </li>
  <li>
<strong>Talks and Posters</strong>
    <ul>
      <li><a href="https://www.youtube.com/watch?v=Xd4erPj0uEs" rel="external nofollow noopener" target="_blank">PyCon DE &amp; PyData Berlin 2022</a></li>
      <li><a href="https://epapoutsellis.github.io/assets/pdf/poster_STEM_for_Britain.pdf" rel="external nofollow noopener" target="_blank">STEM for Britain Poster, Finalist Mathematics Section, 2020</a></li>
      <li><a href="https://editor.postreality.io/view/addf28cc-2830-11ec-966e-d792f7fbd6cb" rel="external nofollow noopener" target="_blank">Augmented Reality Poster</a></li>
    </ul>
  </li>
</ul>

<p>To join the CIL community, you can register at our <a href="https://discord.com/invite/9NTWu9MEGq" rel="external nofollow noopener" target="_blank">Discord channel</a>.</p>

<h2 id="cloud-platforms-">Cloud platforms <a class="anchor" id="section2"></a>
</h2>

<p>In addition to the local installation available via conda, see <a href="https://github.com/TomographicImaging/CIL#installation-of-cil" rel="external nofollow noopener" target="_blank">here</a>, we have two alternatives to use CIL on the cloud: 1) Binder and 2) Google Colab.</p>

<ul>
  <li>
    <p>Binder: The <a href="https://mybinder.readthedocs.io/en/latest/#" rel="external nofollow noopener" target="_blank">Binder Project</a> offers an easy place to create sharable, interactive, reproducible computing environments. Using the <a href="https://mybinder.org/" rel="external nofollow noopener" target="_blank">mybinder.org</a> platform we transform a github repository into a collection of interactive notebooks without any installation. So, you are one click away from our CIL demos: <a href="https://mybinder.org/v2/gh/TomographicImaging/CIL-Demos/HEAD?urlpath=lab/tree/binder%2Findex.ipynb" rel="external nofollow noopener" target="_blank"><img src="https://mybinder.org/badge_logo.svg" alt="Binder"></a></p>
  </li>
  <li>
    <p>Google Colab: Google Colaboratory, or “Colab” is a cloud-based Jupyter notebook environment. It runs on Google Cloud Platform (GCP), and provides free access to GPUs and TPUs with many pre-installed scientific libraries.</p>
  </li>
</ul>

<h2 id="binder-or-colab-">Binder or Colab <a class="anchor" id="subsection21"></a>
</h2>

<p>In my opinion, the easiest choice to check some interactive jupyter demos and see the interface of an open source software, is Binder. However, in this case only CPU is available which is not the best option for tomography imaging. Also, you have limited memory and space if you want to upload some tomography datasets. A couple years ago, Binder was quite fast when building your image and if the image was recently built you could see the interactive demos in less than one minute. Nowdays, Binderhub servers have a lot of activity with many users and requesting a server can take a lot of time and sometimes you will receive a message such as : <em>Found built image, launching… Too many users on this BinderHub! Try again soon.</em>.</p>

<p>In the case of Colab, we have the option of a free GPU up to 16Gb, which is very useful for tomography imaging and reconstruction. Also, you can upload some datasets to your personal google drive. However, CIL or other packages are not pre-installed in you jupyter environment. Therefore, we need to use <code class="language-plaintext highlighter-rouge">pip</code> or <code class="language-plaintext highlighter-rouge">conda</code> to install our software. Pip is the default option to install python libraries on Google Colab, e.g., <code class="language-plaintext highlighter-rouge">!pip install name_of_package</code>. Unfortunately, Conda is not available by default and we need to install it first and then use it, e.g., <code class="language-plaintext highlighter-rouge">!conda install name_of_package</code>.</p>

<p><strong>Please note that Colab has recently upgraded its default runtime to Python version 3.10.</strong>
The next version of Python (3.11) is scheduled to have its final regular bug fix release in April 2024. Previous version (Python 3.9) is available from the <code class="language-plaintext highlighter-rouge">Command Palette</code> (<code class="language-plaintext highlighter-rouge">Ctrl+Shift+P</code>) via the <code class="language-plaintext highlighter-rouge">Use fallback runtime version</code> command when connected to a runtime. This will be available until mid-May 2023. See <a href="https://medium.com/google-colab/colab-updated-to-python-3-10-27eb02daa162" rel="external nofollow noopener" target="_blank">here</a> for more information.</p>

<h2 id="install-cil-on-colab-">Install CIL on Colab <a class="anchor" id="section3"></a>
</h2>

<p>In this section, we discuss how to install CIL and all its dependencies on Google Colab required for this notebook. In CIL, we provide wrappers for two tomography backends: 1) <a href="https://github.com/astra-toolbox/astra-toolbox" rel="external nofollow noopener" target="_blank">Astra-Toolbox</a> and 2) <a href="https://github.com/CERN/TIGRE" rel="external nofollow noopener" target="_blank">TIGRE</a>. In addition, we are going to use the <a href="https://github.com/vais-ral/CCPi-Regularisation-Toolkit" rel="external nofollow noopener" target="_blank">CCPi-Regularisation-Toolkit</a> which provides a set of 2D/3D regularisation methods with CPU/GPU acceleration. We follow the installation steps below:</p>

<p>1) Check python version on your current jupyter session. It should be <code class="language-plaintext highlighter-rouge">Python &gt;=3.10</code>.</p>

<p>2) Install TIGRE tomography backend following similar steps to <a href="https://github.com/CERN/TIGRE/blob/master/Frontispiece/python_installation.md" rel="external nofollow noopener" target="_blank">Python installation</a>.</p>

<p>3) Install the <a href="https://github.com/conda-incubator/condacolab" rel="external nofollow noopener" target="_blank">condacolab</a> package. This is the easiest way to install install <code class="language-plaintext highlighter-rouge">conda</code> on google colab.</p>

<p>4) Import <code class="language-plaintext highlighter-rouge">condacolab</code> and install <code class="language-plaintext highlighter-rouge">conda</code>.</p>

<p>5) Install CIL with the Astra-Toolbox backend and the CCPi-Regularisation Toolkit using <code class="language-plaintext highlighter-rouge">conda</code>.</p>

<p>You can try this notebook directly on Google Colab. <a href="https://colab.research.google.com/github/epapoutsellis/blogs/blob/main/CIL_Cloud.ipynb" rel="external nofollow noopener" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>

<h3 id="check-python-version-">Check Python version <a class="anchor" id="subsection31"></a>
</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!python --version
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Python 3.10.11
</code></pre></div></div>

<h3 id="install-tigre-">Install TIGRE <a class="anchor" id="subsection32"></a>
</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!git clone https://github.com/CERN/TIGRE.git
%cd TIGRE/Python
!python setup.py install
!python example.py
</code></pre></div></div>

<h3 id="install-condacolab-">Install CondaColab <a class="anchor" id="subsection33"></a>
</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!pip install -q condacolab
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">condacolab</span>
</code></pre></div></div>

<h3 id="install-conda-">Install Conda <a class="anchor" id="subsection34"></a>
</h3>

<p><strong>Note:</strong> Please wait for the kernel to restart.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">condacolab</span><span class="p">.</span><span class="nf">install</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="install-cil-">Install CIL <a class="anchor" id="subsection35"></a>
</h3>

<p>Using the command below we install CIL, Astra-Toolbox and the CCPi-Regularisation toolkit via <code class="language-plaintext highlighter-rouge">conda</code> or <code class="language-plaintext highlighter-rouge">mamba</code>. We are going to use <a href="https://github.com/mamba-org/mamba" rel="external nofollow noopener" target="_blank">Mamba</a>, a fast cross-platform package manager from <a href="https://quantstack.net/" rel="external nofollow noopener" target="_blank">Quantstack</a>.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
!mamba install -c conda-forge -c intel -c ccpi cil=23.0.1 astra-toolbox ccpi-regulariser "ipywidgets&lt;8" --quiet
!cp -r /usr/local/lib/python3.10/site-packages/astra_toolbox-2.0.0-py3.10-linux-x86_64.egg/astra /usr/local/lib/python3.10/site-packages/

</code></pre></div></div>

<h3 id="check-cil-version">Check CIL version</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">cil.version</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cil</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>23.0.1
</code></pre></div></div>

<h2 id="tomography-reconstruction-using-cil-">Tomography reconstruction using CIL <a class="anchor" id="section4"></a>
</h2>

<p>We are now ready to use CIL to perform tomography reconstruction on a real tomography dataset.</p>

<h3 id="limited-angle-tomography-reconstruction">Limited Angle Tomography Reconstruction</h3>

<p>We are going to use a three-dimensional parallel-beam X-ray CT real dataset from Beamline I13-2, Diamond Light Source, Harwell, UK.</p>

<p>The sample consisted of a 0.5 mm aluminium cylinder with a piece of steel wire embedded in a small drilled hole. A droplet of salt water was placed on top, causing corrosion to form hydrogen bubbles. The dataset, which was part of a fast time-lapse experiment, consists of 91 projections over 180, originally acquired as size 2560-by-2160 pixels, and it is downsampled to 160-by-135 pixels see <a href="https://github.com/DiamondLightSource/Savu/blob/master/test_data/data/24737_fd.nxs" rel="external nofollow noopener" target="_blank">here</a>.</p>

<p>We reconstruct this dataset using analytic and iterative reconstruction methods with a limited number of projections:</p>

<ul>
  <li>
    <p>the Filtered Back Projection (FBP) algorithm,</p>
  </li>
  <li>
    <p>Total variation (TV) regularisation under a non-negativity constraint</p>

    <p><a class="anchor" id="tv_reg"></a>
  \(\begin{equation}
  \underset{u}{\operatorname{argmin}} \frac{1}{2} \| A u - d\|^{2}_{2} + \alpha\,\mathrm{TV}(u) + \mathbb{I}_{\{u\geq0\}}(u) 
  \end{equation}\)</p>

    <p>where, \(d\) is the noisy sinogram and \(A\) is the Projection operator.</p>
  </li>
</ul>

<h3 id="import-libraries-">Import libraries <a class="anchor" id="subsection41"></a>
</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">cil.framework</span> <span class="kn">import</span>  <span class="n">AcquisitionGeometry</span>
<span class="kn">from</span> <span class="n">cil.processors</span> <span class="kn">import</span> <span class="n">TransmissionAbsorptionConverter</span><span class="p">,</span> <span class="n">Slicer</span><span class="p">,</span> <span class="n">CentreOfRotationCorrector</span>
<span class="kn">from</span> <span class="n">cil.optimisation.functions</span> <span class="kn">import</span> <span class="n">L2NormSquared</span>
<span class="kn">from</span> <span class="n">cil.optimisation.algorithms</span> <span class="kn">import</span> <span class="n">PDHG</span>
<span class="kn">from</span> <span class="n">cil.utilities.display</span> <span class="kn">import</span> <span class="n">show2D</span><span class="p">,</span> <span class="n">show_geometry</span>
<span class="kn">from</span> <span class="n">cil.utilities</span> <span class="kn">import</span> <span class="n">dataexample</span>
<span class="kn">from</span> <span class="n">cil.utilities.jupyter</span> <span class="kn">import</span> <span class="n">islicer</span>
<span class="kn">from</span> <span class="n">cil.plugins.ccpi_regularisation.functions</span> <span class="kn">import</span> <span class="n">FGP_TV</span>

<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
</code></pre></div></div>

<h3 id="import-tomography-backends-astra-and-tigre-">Import tomography backends: ASTRA and TIGRE <a class="anchor" id="subsection42"></a>
</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Astra Backend
</span><span class="kn">from</span> <span class="n">cil.plugins.astra</span> <span class="kn">import</span> <span class="n">ProjectionOperator</span> <span class="k">as</span> <span class="n">AstraProjectionOperator</span>
<span class="kn">from</span> <span class="n">cil.plugins.astra</span> <span class="kn">import</span> <span class="n">FBP</span> <span class="k">as</span> <span class="n">AstraFBP</span>

<span class="c1"># TIGRE backend
</span><span class="kn">from</span> <span class="n">cil.plugins.tigre</span> <span class="kn">import</span> <span class="n">ProjectionOperator</span> <span class="k">as</span> <span class="n">TigreProjectionOperator</span>
<span class="kn">from</span> <span class="n">cil.plugins.tigre</span> <span class="kn">import</span> <span class="n">FBP</span> <span class="k">as</span> <span class="n">TigreFBP</span>
</code></pre></div></div>

<h3 id="load-and-examine-dataset-">Load and examine dataset <a class="anchor" id="subsection43"></a>
</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># data_raw = dataexample.SYNCHROTRON_PARALLEL_BEAM_DATA.get() # local installation
</span><span class="n">data_raw</span> <span class="o">=</span> <span class="n">dataexample</span><span class="p">.</span><span class="n">SYNCHROTRON_PARALLEL_BEAM_DATA</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/usr/local/share/cil</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># google colab 
</span></code></pre></div></div>

<h3 id="preprocess-acquisition-data-">Preprocess Acquisition Data <a class="anchor" id="subsection44"></a>
</h3>

<p>In the code above, we preprocess our acquired data:</p>

<ul>
  <li>Convert to Absorption using the <a href="https://en.wikipedia.org/wiki/Beer%E2%80%93Lambert_law" rel="external nofollow noopener" target="_blank">Beer-Lambert</a> law.</li>
  <li>Correct for centre of rotation artifacts.</li>
  <li>Simulate a limited angled tomography dataset. Our raw data has 91 projections, but we are going to use only 15 of them.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">background</span> <span class="o">=</span> <span class="n">data_raw</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="mi">20</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">data_raw</span> <span class="o">/=</span> <span class="n">background</span>

<span class="c1"># Lambert-Beer law
</span><span class="n">data_abs</span> <span class="o">=</span> <span class="nc">TransmissionAbsorptionConverter</span><span class="p">()(</span><span class="n">data_raw</span><span class="p">)</span>
<span class="n">data_crop</span> <span class="o">=</span> <span class="nc">Slicer</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)})(</span><span class="n">data_abs</span><span class="p">)</span>

<span class="c1"># Reorder the shape of sinogram only if astra backend is used
</span><span class="n">data_crop</span><span class="p">.</span><span class="nf">reorder</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="sh">'</span><span class="s">astra</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Correct centre of rotation artifacts
</span><span class="n">data_centred</span> <span class="o">=</span> <span class="n">CentreOfRotationCorrector</span><span class="p">.</span><span class="nf">xcorrelation</span><span class="p">()(</span><span class="n">data_crop</span><span class="p">)</span>

<span class="c1"># Reduce number of projections
</span><span class="n">data_sliced</span> <span class="o">=</span> <span class="nc">Slicer</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">angle</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">1</span><span class="p">)})(</span><span class="n">data_centred</span><span class="p">)</span>

<span class="c1"># Get acquisition geometry
</span><span class="n">ag</span> <span class="o">=</span> <span class="n">data_sliced</span><span class="p">.</span><span class="n">geometry</span>

<span class="c1"># Get image geometry
</span><span class="n">ig</span> <span class="o">=</span> <span class="n">ag</span><span class="p">.</span><span class="nf">get_ImageGeometry</span><span class="p">()</span>

</code></pre></div></div>

<h3 id="show-acquisition-geometry">Show Acquisition Geometry</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">show_geometry</span><span class="p">(</span><span class="n">ag</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/blogs/CIL_Cloud_files/CIL_Cloud_29_0.png" width="720"></p>

<h3 id="run-analytic-reconstruction-fbp-using-astra-and-tigre-">Run analytic reconstruction: FBP using Astra and Tigre <a class="anchor" id="subsection45"></a>
</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_sliced</span><span class="p">.</span><span class="nf">reorder</span><span class="p">(</span><span class="sh">'</span><span class="s">tigre</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fbp_recon_tigre</span> <span class="o">=</span> <span class="nc">TigreFBP</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">gpu</span><span class="sh">'</span><span class="p">)(</span><span class="n">data_sliced</span><span class="p">)</span>

<span class="n">data_sliced</span><span class="p">.</span><span class="nf">reorder</span><span class="p">(</span><span class="sh">'</span><span class="s">astra</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fbp_recon_astra</span> <span class="o">=</span> <span class="nc">AstraFBP</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">gpu</span><span class="sh">'</span><span class="p">)(</span><span class="n">data_sliced</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># visualise reconstruction results
</span><span class="nf">show2D</span><span class="p">(</span><span class="n">fbp_recon_astra</span><span class="p">,</span> <span class="n">slice_list</span><span class="o">=</span><span class="p">[(</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">,</span><span class="mi">80</span><span class="p">),</span> 
                              <span class="p">(</span><span class="sh">'</span><span class="s">horizontal_y</span><span class="sh">'</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> 
                              <span class="p">(</span><span class="sh">'</span><span class="s">horizontal_x</span><span class="sh">'</span><span class="p">,</span><span class="mi">50</span><span class="p">)],</span> \
        <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">inferno</span><span class="sh">"</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Astra: FBP reconstruction</span><span class="sh">"</span><span class="p">,</span> 
       <span class="n">fix_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span>
       <span class="n">origin</span><span class="o">=</span><span class="sh">'</span><span class="s">upper-left</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">show2D</span><span class="p">(</span><span class="n">fbp_recon_tigre</span><span class="p">,</span> <span class="n">slice_list</span><span class="o">=</span><span class="p">[(</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">,</span><span class="mi">80</span><span class="p">),</span> 
                              <span class="p">(</span><span class="sh">'</span><span class="s">horizontal_y</span><span class="sh">'</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> 
                              <span class="p">(</span><span class="sh">'</span><span class="s">horizontal_x</span><span class="sh">'</span><span class="p">,</span><span class="mi">50</span><span class="p">)],</span> \
        <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">inferno</span><span class="sh">"</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Tigre: FBP reconstruction</span><span class="sh">"</span><span class="p">,</span> 
       <span class="n">fix_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span>
       <span class="n">origin</span><span class="o">=</span><span class="sh">'</span><span class="s">upper-left</span><span class="sh">'</span><span class="p">)</span>

</code></pre></div></div>

<p><img src="/assets/img/blogs/CIL_Cloud_files/CIL_Cloud_32_0.png" width="720">  <br>
<img src="/assets/img/blogs/CIL_Cloud_files/CIL_Cloud_32_1.png" width="720"></p>

<h3 id="run-model-based-iterative-reconstruction-total-variation-reconstruction-">Run Model-Based iterative reconstruction: Total variation reconstruction <a class="anchor" id="subsection46"></a>
</h3>

<p>The images on the first column are perfect if you are interested to very cool and futuristic star-shaped art. If we examine other slices they are far from perfect for tomography reconstruction. These artifacts are well known when we use analytic reconstruction algoritms on data with a limited number of projections, see <a href="https://royalsocietypublishing.org/doi/abs/10.1098/rsta.2020.0192" rel="external nofollow noopener" target="_blank">Core Imaging Library–Part I: a versatile Python framework for tomographic imaging</a>.</p>

<p>To reduce these artifacts, we are going to use <strong>Model-Based Iterative Reconstruction (MBIR)</strong> algorithms. We use the <a href="https://link.springer.com/article/10.1007/s10851-010-0251-1" rel="external nofollow noopener" target="_blank">Primal-Dual Hybrid Gradient (PDHG)</a>
with <a href="https://en.wikipedia.org/wiki/Total_variation" rel="external nofollow noopener" target="_blank">Total Variation (TV)</a> regularisation under a non-negativity constraint.</p>

<p>The PDHG algorithm solves the following problem:</p>

<p><a id="pdhg_alg"></a>
\(\begin{equation}
\underset{x\in \mathbb{X} }{\operatorname{argmin}} f(Kx) + g(x)
\tag{2}
\end{equation}\)</p>

<p>which is the sum of a composite function \(f\) with a linear operator \(K\) and a proximable function \(g\).</p>

<p>So, in order to use the PDHG algorithm in CIL, we need to find the triplet $(f, g, K)$ in order to express the minimisation problem <a href="#tv_reg">(1)</a> to the general PDHG form <a href="#pdhg_alg">(2)</a>.</p>

<ul>
  <li>
    <p>In our case, we have \(K = A\) , i.e., our Astra projection operator <code class="language-plaintext highlighter-rouge">A = AstraProjectionOperator(ig, ag, device="gpu")</code> <strong>Note: cpu option is not available for the TIGRE backend</strong></p>
  </li>
  <li>
    <p>The first term in <a href="#tv_reg">(1)</a>, also called <strong>fidelity term</strong>, is \(f(u) = \frac{1}{2}\|Au - d\|^{2}\) and in CIL syntax, is <code class="language-plaintext highlighter-rouge">F = LeastSquares(A=A, b=data_centred, c=0.5)</code></p>
  </li>
  <li>
    <p>The second term in <a href="#tv_reg">(1)</a> is the TV <strong>regulariser</strong> with a non-negativity constraint and in CIL syntax is <code class="language-plaintext highlighter-rouge">G = alpha * FGP_TV(nonnegativity=True, device = "gpu")</code>, where <code class="language-plaintext highlighter-rouge">alpha</code> is the regularisation parameter.</p>
  </li>
</ul>

<p>Now, it is time to run the PDHG algorithm, for 100 iterations. We can initialise our algorithm from an array of zeros, <code class="language-plaintext highlighter-rouge">ig.allocate()</code> or the previous FBP reconstruction. We also print the objective of the primal problem every 10 iterations using <code class="language-plaintext highlighter-rouge">verbose=1</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Projection Operator
</span><span class="n">A</span> <span class="o">=</span> <span class="nc">AstraProjectionOperator</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">"</span><span class="s">gpu</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Fidelity term
</span><span class="n">F</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nc">L2NormSquared</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">data_sliced</span><span class="p">)</span>

<span class="c1"># TV regularization
</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="nc">FGP_TV</span><span class="p">(</span><span class="n">nonnegativity</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpu</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># setup and run PDHG algorithm
</span><span class="n">pdhg</span> <span class="o">=</span> <span class="nc">PDHG</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">fbp_recon_astra</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> 
            <span class="n">update_objective_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">max_iteration</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">pdhg</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     Iter   Max Iter     Time/Iter            Objective
                               [s]                     
        0        100         0.000          3.81659e+03
       10        100         0.176          1.78921e+02
       20        100         0.172          1.60171e+02
       30        100         0.172          1.56264e+02
       40        100         0.175          1.55244e+02
       50        100         0.175          1.54886e+02
       60        100         0.176          1.54706e+02
       70        100         0.175          1.54649e+02
       80        100         0.176          1.54622e+02
       90        100         0.176          1.54605e+02
      100        100         0.177          1.54597e+02
-------------------------------------------------------
      100        100         0.177          1.54597e+02
Stop criterion has been reached.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">show2D</span><span class="p">(</span><span class="n">pdhg</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span> <span class="n">slice_list</span><span class="o">=</span><span class="p">[(</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">,</span><span class="mi">80</span><span class="p">),</span> 
                              <span class="p">(</span><span class="sh">'</span><span class="s">horizontal_y</span><span class="sh">'</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> 
                              <span class="p">(</span><span class="sh">'</span><span class="s">horizontal_x</span><span class="sh">'</span><span class="p">,</span><span class="mi">50</span><span class="p">)],</span> \
        <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">inferno</span><span class="sh">"</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">TV: alpha = {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span>
        <span class="n">fix_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="sh">'</span><span class="s">upper</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/img/blogs/CIL_Cloud_files/CIL_Cloud_35_0.png" width="720"></p>

<h2 id="discussion-">Discussion <a class="anchor" id="subsection47"></a>
</h2>

<p>Using the iterative reconstruction approach, we successfully eliminated the noise and streak artifacts from our initial analytic reconstruction. However, in order to determine whether the resulting reconstruction is good or bad requires further evaluation and assessment. For this particular dataset, we can perform the following comparison. We can reconstruct our dataset using all 91 projections with the FBP algorithm and compare it with our TV reconstructed image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_full</span> <span class="o">=</span> <span class="nc">Slicer</span><span class="p">(</span><span class="n">roi</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">1</span><span class="p">)})(</span><span class="n">data_centred</span><span class="p">)</span>
<span class="n">ag_full</span> <span class="o">=</span> <span class="n">data_full</span><span class="p">.</span><span class="n">geometry</span>
<span class="n">ig_full</span> <span class="o">=</span> <span class="n">ag_full</span><span class="p">.</span><span class="nf">get_ImageGeometry</span><span class="p">()</span>
<span class="n">fbp_full_astra</span> <span class="o">=</span> <span class="nc">AstraFBP</span><span class="p">(</span><span class="n">ig_full</span><span class="p">,</span> <span class="n">ag_full</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">gpu</span><span class="sh">'</span><span class="p">)(</span><span class="n">data_full</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_recons</span> <span class="o">=</span> <span class="p">[</span><span class="n">fbp_full_astra</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="mi">80</span><span class="p">),</span> <span class="n">fbp_recon_astra</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="mi">80</span><span class="p">),</span> <span class="n">pdhg</span><span class="p">.</span><span class="n">solution</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">vertical</span><span class="o">=</span><span class="mi">80</span><span class="p">),</span>
              <span class="n">fbp_full_astra</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">horizontal_y</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">fbp_recon_astra</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">horizontal_y</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">pdhg</span><span class="p">.</span><span class="n">solution</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">horizontal_y</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
              <span class="n">fbp_full_astra</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">horizontal_x</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">fbp_recon_astra</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">horizontal_x</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span> <span class="n">pdhg</span><span class="p">.</span><span class="n">solution</span><span class="p">.</span><span class="nf">get_slice</span><span class="p">(</span><span class="n">horizontal_x</span><span class="o">=</span><span class="mi">50</span><span class="p">)]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
<span class="kn">from</span> <span class="n">mpl_toolkits.axes_grid1.anchored_artists</span> <span class="kn">import</span> <span class="n">AnchoredSizeBar</span>     

<span class="n">labels_x</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">FBP</span><span class="se">\n</span><span class="s"> All data</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">FBP</span><span class="se">\n</span><span class="s"> Limited data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TV reconstruction</span><span class="se">\n</span><span class="s"> Limited data</span><span class="sh">"</span><span class="p">]</span>
<span class="n">labels_y</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Vertical</span><span class="se">\n</span><span class="s"> slice = 80</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Horizontal_y</span><span class="se">\n</span><span class="s"> slice = 50</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Horizontal_x</span><span class="se">\n</span><span class="s"> slice = 50</span><span class="sh">"</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">grid</span> <span class="o">=</span> <span class="nc">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span>
                <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span>
                <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">cbar_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">single</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">cbar_location</span><span class="o">=</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">cbar_size</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.1</span>
                <span class="p">)</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">:</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">all_recons</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">array</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">inferno</span><span class="sh">"</span><span class="p">)</span>
    
                  
    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">labels_x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="n">labels_y</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">divmod</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nrows</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                  
                
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_yticks</span><span class="p">([])</span>
    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
    
<span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="n">cax</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/blogs/CIL_Cloud_files/CIL_Cloud_39_0.png" width="720"></p>

<h2 id="more-cil-demos-">More CIL-Demos <a class="anchor" id="section5"></a>
</h2>

<p>To try more demos on Google Colab, please visit our <a href="https://github.com/TomographicImaging/CIL-Demos" rel="external nofollow noopener" target="_blank">CIL-Demos</a> repository and load one of our notebooks to the Google Colab platform and repeat the installation steps above. Please note that for some notebooks you need to download first the dataset required to run the notebook.</p>


    </div>
  </article><div id="giscus_thread" style="max-width: 1000px; margin: 0 auto;">
  <script>
    let giscusTheme = localStorage.getItem("theme");
    let giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo": "epapoutsellis/epapoutsellis.github.io",
        "data-repo-id": "R_kgDOJW1Jbg",
        "data-category": "General",
        "data-category-id": "DIC_kwDOJW1Jbs4CWtpm",
        "data-mapping": "pathname",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "1",
        "data-input-position": "bottom",
        "data-theme": giscusTheme,
        "data-lang": "en",
        "crossorigin": "anonymous",
        "async": "",
    };


    let giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
    document.getElementById("giscus_thread").appendChild(giscusScript);
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a>
</noscript>
</div>
</div>

          </div>
        </div>
        
      
    </div>

    <!-- Footer -->    <footer class="sticky-bottom mt-5">
      <div class="container">
        © Copyright 2023 Evangelos  Papoutsellis. Last updated: June 07, 2023.
      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>
  <!-- Sidebar Table of Contents -->
  <script defer src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>


  <!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>

    
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-156508599-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-156508599-1');
  </script>
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
